<!-- resources/views/clientes/form.html -->
<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary" id="form-title">Novo Cliente</h6>
            <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="btn-voltar">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
            </div>
        </div>
        <div class="card-body">
            <form id="form-cliente">
                <div class="row">
                    <!-- Campo código -->
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="CLICOD">Código:</label>
                            <input type="text" class="form-control" id="CLICOD" name="CLICOD" readonly>
                        </div>
                    </div>
                    
                    <!-- Campo tipo -->
                    <div class="col-md-2">
                        <div class="form-group">
                            <label for="CLITIP">Tipo:</label>
                            <select class="form-control" id="CLITIP" name="CLITIP">
                                <option value="">Selecione...</option>
                                <option value="F">F - Pessoa Física</option>
                                <option value="J">J - Pessoa Jurídica</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Campo CPF/CNPJ -->
                    <div class="col-md-3">
                        <div class="form-group">
                            <label for="CLIDOC">CPF/CNPJ:</label>
                            <div class="input-group">
                                <input type="text" class="form-control cpf-cnpj-mask" id="CLIDOC" name="CLIDOC" placeholder="000.000.000-00">
                                <button class="btn btn-outline-secondary" type="button" id="btn-consultar-doc">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campo Modalidade -->
                    <div class="col-md-5">
                        <div class="form-group">
                            <label for="CLIMOD">Modalidade:</label>
                            <div class="input-group">
                                <select class="form-control" id="CLIMOD" name="CLIMOD">
                                    <option value="">Selecione...</option>
                                    <!-- Opções serão carregadas via JavaScript -->
                                </select>
                                <input type="text" class="form-control" id="MODDES" name="MODDES" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Campo Razão Social -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="CLIRAZ">Razão Social:</label>
                            <input type="text" class="form-control" id="CLIRAZ" name="CLIRAZ" maxlength="40">
                        </div>
                    </div>
                    
                    <!-- Campo Nome Fantasia -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="CLIFAN">Nome Fantasia:</label>
                            <input type="text" class="form-control" id="CLIFAN" name="CLIFAN" maxlength="20">
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Campo Município -->
                    <div class="col-md-8">
                        <div class="form-group">
                            <label for="CLIMUN">Município:</label>
                            <input type="text" class="form-control" id="CLIMUN" name="CLIMUN" maxlength="40">
                        </div>
                    </div>
                    
                    <!-- Campo UF -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="CLIEST">UF:</label>
                            <select class="form-control" id="CLIEST" name="CLIEST">
                                <option value="">Selecione...</option>
                                <option value="AC">AC</option>
                                <option value="AL">AL</option>
                                <!-- Demais UFs... -->
                                <option value="SP">SP</option>
                                <option value="TO">TO</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Campo Responsável -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="CLIRES">Responsável:</label>
                            <input type="text" class="form-control" id="CLIRES" name="CLIRES" maxlength="20">
                        </div>
                    </div>
                    
                    <!-- Campo Valor Hora -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="CLIVAL">Valor Hora:</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="text" class="form-control currency-mask" id="CLIVAL" name="CLIVAL">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Campo E-mail OS -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="CLIEOS">E-mail OS:</label>
                            <input type="email" class="form-control" id="CLIEOS" name="CLIEOS" maxlength="100">
                        </div>
                    </div>
                    
                    <!-- Campo E-mail NF -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="CLIENF">E-mail NF:</label>
                            <input type="email" class="form-control" id="CLIENF" name="CLIENF" maxlength="100">
                        </div>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                        <button type="reset" class="btn btn-secondary">
                            <i class="fas fa-undo"></i> Limpar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

// Adicionar no final do arquivo form.html
<script>
    // Script específico para o formulário de cliente
    document.addEventListener('DOMContentLoaded', function() {
        // Configurar validação do formulário
        const form = document.getElementById('form-cliente');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Validar formulário
                if (validarFormCliente()) {
                    // Limpar máscaras antes de enviar
                    const tipoPessoa = document.getElementById('CLITIP').value;
                    const cpfCnpj = document.getElementById('CLIDOC');
                    if (cpfCnpj.value) {
                        cpfCnpj.value = cpfCnpj.value.replace(/\D/g, '');
                    }
                    
                    const valorHora = document.getElementById('CLIVAL');
                    if (valorHora.value) {
                        valorHora.value = valorHora.value.replace(/[^\d,]/g, '').replace(',', '.');
                    }
                    
                    // Serializar dados do formulário
                    const data = {
                        action: 'salvar_cliente'
                    };
                    
                    // Adicionar campos ao objeto de dados
                    const formData = new FormData(form);
                    formData.forEach(function(value, key) {
                        data[key] = value;
                    });
                    
                    // Enviar requisição
                    salvarCliente(data)
                        .then(response => {
                            if (response.success) {
                                showAlert(response.message, 'success');
                                
                                // Redirecionar para a listagem após 1,5 segundos
                                setTimeout(() => {
                                    loadClientesContent();
                                }, 1500);
                            } else {
                                showAlert(response.message, 'danger');
                            }
                        })
                        .catch(error => {
                            showAlert('Erro ao salvar cliente: ' + error.message, 'danger');
                        });
                }
            });
        }
        
        // Configurar botão voltar
        document.getElementById('btn-voltar').addEventListener('click', function() {
            loadClientesContent();
        });
        
        // Configurar campo CPF/CNPJ conforme o tipo de pessoa
        const tipoPessoa = document.getElementById('CLITIP');
        const cpfCnpj = document.getElementById('CLIDOC');
        const labelCpfCnpj = document.querySelector('label[for="CLIDOC"]');
        
        if (tipoPessoa && cpfCnpj && labelCpfCnpj) {
            tipoPessoa.addEventListener('change', function() {
                if (this.value === 'F') {
                    // Pessoa Física - CPF
                    labelCpfCnpj.innerText = 'CPF:';
                    cpfCnpj.setAttribute('placeholder', '000.000.000-00');
                    cpfCnpj.classList.remove('cnpj-mask');
                    cpfCnpj.classList.add('cpf-mask');
                } else if (this.value === 'J') {
                    // Pessoa Jurídica - CNPJ
                    labelCpfCnpj.innerText = 'CNPJ:';
                    cpfCnpj.setAttribute('placeholder', '00.000.000/0000-00');
                    cpfCnpj.classList.remove('cpf-mask');
                    cpfCnpj.classList.add('cnpj-mask');
                } else {
                    // Tipo não definido
                    labelCpfCnpj.innerText = 'CPF/CNPJ:';
                    cpfCnpj.setAttribute('placeholder', '');
                    cpfCnpj.classList.remove('cpf-mask');
                    cpfCnpj.classList.remove('cnpj-mask');
                }
                
                // Limpar campo
                cpfCnpj.value = '';
            });
        }
        
        // Configurar consulta de CPF/CNPJ
        const btnConsultarDoc = document.getElementById('btn-consultar-doc');
        if (btnConsultarDoc) {
            btnConsultarDoc.addEventListener('click', function() {
                const documento = document.getElementById('CLIDOC').value;
                const tipo = document.getElementById('CLITIP').value;
                
                if (!documento || !tipo) {
                    showAlert('Informe o tipo de pessoa e o documento para consultar.', 'warning');
                    return;
                }
                
                // Limpar caracteres não numéricos para a consulta
                const docLimpo = documento.replace(/\D/g, '');
                
                // Exibir loader
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
                this.disabled = true;
                
                // Consultar documento
                consultarDocumento(docLimpo, tipo)
                    .then(data => {
                        if (data.success) {
                            // Preencher campos com os dados retornados
                            document.getElementById('CLIRAZ').value = data.razaoSocial || '';
                            document.getElementById('CLIFAN').value = data.nomeFantasia || '';
                            document.getElementById('CLIMUN').value = data.municipio || '';
                            document.getElementById('CLIEST').value = data.uf || '';
                            
                            showAlert('Dados consultados com sucesso!', 'success');
                        } else {
                            showAlert(data.message || 'Documento não encontrado.', 'warning');
                        }
                    })
                    .catch(error => {
                        showAlert('Erro ao consultar documento: ' + error.message, 'danger');
                    })
                    .finally(() => {
                        // Restaurar botão
                        this.innerHTML = '<i class="fas fa-search"></i>';
                        this.disabled = false;
                    });
            });
        }
        
        // Carregar modalidades para o select
        loadModalidadesSelect('CLIMOD');
        
        // Configurar evento para exibir descrição da modalidade
        document.getElementById('CLIMOD').addEventListener('change', function() {
            const modalidadeId = this.value;
            
            if (modalidadeId) {
                // Buscar descrição da modalidade
                fetchModalidade(modalidadeId)
                    .then(response => {
                        if (response.success) {
                            document.getElementById('MODDES').value = response.modalidade.MODDES;
                        } else {
                            document.getElementById('MODDES').value = '';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao carregar modalidade:', error);
                        document.getElementById('MODDES').value = '';
                    });
            } else {
                document.getElementById('MODDES').value = '';
            }
        });
        
        // Verificar se é edição e carregar dados
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const modo = urlParams.get('modo');
        
        if (id) {
            // Atualizar título
            document.getElementById('form-title').textContent = modo === 'visualizar' ? 'Visualizar Cliente' : 'Editar Cliente';
            
            // Carregar dados do cliente
            fetchCliente(id)
                .then(response => {
                    if (response.success) {
                        const cliente = response.cliente;
                        
                        // Preencher formulário
                        document.getElementById('CLICOD').value = cliente.CLICOD;
                        document.getElementById('CLITIP').value = cliente.CLITIP;
                        document.getElementById('CLIDOC').value = formatDocument(cliente.CLIDOC, cliente.CLITIP);
                        document.getElementById('CLIRAZ').value = cliente.CLIRAZ;
                        document.getElementById('CLIFAN').value = cliente.CLIFAN || '';
                        document.getElementById('CLIMUN').value = cliente.CLIMUN || '';
                        document.getElementById('CLIEST').value = cliente.CLIEST || '';
                        document.getElementById('CLIRES').value = cliente.CLIRES || '';
                        document.getElementById('CLIEOS').value = cliente.CLIEOS || '';
                        document.getElementById('CLIENF').value = cliente.CLIENF || '';
                        document.getElementById('CLIMOD').value = cliente.CLIMOD || '';
                        document.getElementById('MODDES').value = cliente.MODDES || '';
                        
                        // Formatar valor hora
                        if (cliente.CLIVAL) {
                            const valor = parseFloat(cliente.CLIVAL);
                            document.getElementById('CLIVAL').value = valor.toLocaleString('pt-BR', {
                                style: 'currency',
                                currency: 'BRL',
                                minimumFractionDigits: 2
                            });
                        }
                        
                        // Se for apenas visualização, desabilitar campos
                        if (modo === 'visualizar') {
                            const inputs = document.querySelectorAll('#form-cliente input, #form-cliente select, #form-cliente button');
                            inputs.forEach(input => {
                                if (input.id !== 'btn-voltar') {
                                    input.disabled = true;
                                }
                            });
                        }
                        
                        // Disparar evento change para atualizar máscara de CPF/CNPJ
                        const event = new Event('change');
                        document.getElementById('CLITIP').dispatchEvent(event);
                    } else {
                        showAlert('Erro ao carregar dados do cliente: ' + response.message, 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Erro ao carregar dados do cliente: ' + error.message, 'danger');
                });
        }
        
        // Configurar máscaras
        setupMasks();
    });
    
    // Função para validar formulário de cliente
    function validarFormCliente() {
        let valido = true;
        
        // Limpar mensagens de erro anteriores
        limparMensagensErro();
        
        // Validar tipo
        const tipo = document.getElementById('CLITIP');
        if (!tipo.value) {
            exibirErro(tipo, 'O tipo de pessoa é obrigatório.');
            valido = false;
        }
        
        // Validar documento (CPF/CNPJ)
        const documento = document.getElementById('CLIDOC');
        if (!documento.value) {
            exibirErro(documento, 'O CPF/CNPJ é obrigatório.');
            valido = false;
        } else {
            // Validar formato conforme o tipo
            if (tipo.value === 'F') {
                if (!validarCPF(documento.value)) {
                    exibirErro(documento, 'CPF inválido.');
                    valido = false;
                }
            } else if (tipo.value === 'J') {
                if (!validarCNPJ(documento.value)) {
                    exibirErro(documento, 'CNPJ inválido.');
                    valido = false;
                }
            }
        }
        
        // Validar razão social
        const razaoSocial = document.getElementById('CLIRAZ');
        if (!razaoSocial.value) {
            exibirErro(razaoSocial, 'A razão social é obrigatória.');
            valido = false;
        }
        
        // Validar e-mail OS (se preenchido)
        const emailOS = document.getElementById('CLIEOS');
        if (emailOS.value && !validarEmail(emailOS.value)) {
            exibirErro(emailOS, 'E-mail inválido.');
            valido = false;
        }
        
        // Validar e-mail NF (se preenchido)
        const emailNF = document.getElementById('CLIENF');
        if (emailNF.value && !validarEmail(emailNF.value)) {
            exibirErro(emailNF, 'E-mail inválido.');
            valido = false;
        }
        
        return valido;
    }
    
    // Função para exibir mensagem de erro para um campo
    function exibirErro(campo, mensagem) {
        campo.classList.add('is-invalid');
        
        // Criar div de feedback
        const feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        feedback.innerText = mensagem;
        
        // Adicionar após o campo
        campo.parentNode.appendChild(feedback);
    }
    
    // Função para limpar mensagens de erro
    function limparMensagensErro() {
        // Remover classe de erro dos campos
        document.querySelectorAll('.is-invalid').forEach(campo => {
            campo.classList.remove('is-invalid');
        });
        
        // Remover mensagens de erro
        document.querySelectorAll('.invalid-feedback').forEach(feedback => {
            feedback.remove();
        });
    }
</script>